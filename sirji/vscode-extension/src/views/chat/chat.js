const BotSvg = `
<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<g clip-path="url(#clip0_375_877)">
<path fill-rule="evenodd" clip-rule="evenodd" d="M11.72 0.0961582C10.9426 0.335883 10.4764 0.943929 10.4764 1.71855C10.4764 2.33869 10.8438 2.99722 11.3753 3.32972C11.4892 3.40106 11.5968 3.42373 11.6143 3.44967C11.6662 3.52644 11.6794 5.73293 11.6289 5.86976C11.5708 6.02699 10.9471 6.7773 10.2674 7.50764L10.1434 7.64085L9.8067 7.27679C9.62152 7.07656 9.39436 6.82615 9.30196 6.7204C9.20951 6.61458 9.06096 6.5079 8.9718 6.48336C8.86256 6.45327 8.79648 6.38783 8.7692 6.2829C8.71849 6.08764 8.52922 5.83663 8.33116 5.70202C8.00673 5.48163 7.48185 5.63302 7.17687 6.03493C7.07109 6.17434 7.04494 6.28062 7.04494 6.57152C7.04494 6.89427 7.06354 6.95428 7.21362 7.11565C7.30642 7.21539 7.45706 7.33545 7.54849 7.38237C7.74712 7.4845 8.15868 7.4949 8.25067 7.40013C8.30042 7.34889 8.45361 7.47924 8.88258 7.93783L9.44886 8.54313L9.09312 8.95486C8.8975 9.18138 8.68911 9.42578 8.63007 9.49812C8.57108 9.57045 8.50529 9.62957 8.4839 9.62957C8.46252 9.62957 8.20655 9.38383 7.91512 9.08346C7.3578 8.50901 6.89401 8.1397 6.6512 8.07689C6.57139 8.05626 6.50611 8.01595 6.50611 7.98732C6.50611 7.95863 6.45716 7.9352 6.39738 7.9352C6.32019 7.9352 6.25933 7.85615 6.18763 7.66282C6.01277 7.19108 5.76927 7.00038 5.34201 7.00038C4.65627 7.00038 4.23667 7.79989 4.60602 8.40256C4.83738 8.78011 5.27003 8.95142 5.63315 8.80921C5.77222 8.7547 5.80835 8.76936 5.97788 8.9492C6.08208 9.05962 6.27543 9.20271 6.40759 9.2671C6.64144 9.38097 7.59642 10.317 7.62784 10.463C7.65558 10.5922 6.23919 12.015 5.36838 12.7326C5.16743 12.8982 4.99029 13.0524 4.9747 13.0752C4.9359 13.1321 4.35992 13.5442 4.31925 13.5442C4.22748 13.5442 3.89703 13.8639 3.89703 13.9527C3.89703 14.0855 4.11279 14.5955 4.22476 14.7273C4.36514 14.8925 4.51028 14.8603 4.94634 14.567C5.03992 14.5041 5.13691 14.4191 5.16187 14.3781C5.18682 14.3372 5.23339 14.3037 5.26538 14.3037C5.33957 14.3037 5.93892 13.8234 5.93892 13.764C5.93892 13.7395 5.97505 13.7194 6.01929 13.7194C6.06347 13.7194 6.10811 13.6968 6.11855 13.6691C6.12893 13.6415 6.26505 13.5067 6.42103 13.3696C7.57753 12.3529 9.03845 10.8486 10.0755 9.60679C10.2067 9.44968 10.3442 9.28877 10.381 9.24928C10.4179 9.20972 10.614 8.98501 10.8168 8.7499C11.5237 7.93018 11.6255 7.81835 11.6649 7.81835C11.6867 7.81835 11.8421 7.99585 12.0102 8.21273C12.2849 8.56697 12.7763 9.17654 13.1055 9.57115C13.1725 9.65149 13.457 9.99416 13.7378 10.3327C14.0185 10.6711 14.3493 11.0655 14.4727 11.2091C14.7508 11.5325 17.0181 13.8631 17.2749 14.0896C17.9849 14.7157 18.1932 14.888 18.2405 14.888C18.27 14.888 18.3027 14.9116 18.3131 14.9406C18.3353 15.0023 19.129 15.6475 19.1827 15.6475C19.2028 15.6475 19.2589 15.6884 19.3074 15.7383C19.4791 15.9151 19.6239 15.8177 19.8271 15.3886C20.0646 14.8874 20.0623 14.8822 19.3309 14.3014C19.038 14.0688 18.7548 13.8361 18.7014 13.7844C18.6481 13.7326 18.4683 13.5719 18.3018 13.4273C17.4102 12.6527 15.9336 11.1339 14.9564 9.98639C14.7541 9.74882 14.5494 9.5122 14.5015 9.46055C14.4535 9.4089 14.2238 9.13003 13.9911 8.84082C13.7583 8.5516 13.5526 8.30183 13.5339 8.28576C13.4874 8.24568 12.4944 6.93143 12.4386 6.83591C12.4073 6.7825 12.8028 6.34097 13.7328 5.39078L15.0719 4.02255L15.4065 4.05859C15.6833 4.08839 15.786 4.07215 16.0014 3.96476C16.1446 3.89336 16.2618 3.80105 16.2618 3.75963C16.2618 3.71826 16.3001 3.65165 16.3469 3.61163C16.4705 3.50588 16.4593 2.95977 16.329 2.73891C15.9368 2.0746 15.0199 2.12444 14.696 2.82766C14.6454 2.9375 14.5658 3.02736 14.5191 3.02736C14.4724 3.02736 14.0714 3.39563 13.6279 3.84575C13.1844 4.29581 12.8044 4.64637 12.7834 4.62475C12.7624 4.60313 12.7452 4.32987 12.7452 4.01752V3.44967L12.9579 3.34725C13.2132 3.22426 13.5409 2.89468 13.718 2.58291C13.8277 2.38975 13.8472 2.27185 13.8477 1.8004C13.8481 1.34497 13.8263 1.20288 13.7266 1.00855C13.5034 0.573563 13.1756 0.306202 12.6056 0.0939378C12.2677 -0.0318548 12.1341 -0.0315041 11.72 0.0961582ZM11.7985 1.2828C11.4287 1.5185 11.4289 2.05246 11.7989 2.31164C12.3753 2.71554 13.1055 2.10288 12.7619 1.5036C12.5718 1.17214 12.1307 1.07107 11.7985 1.2828ZM8.73165 3.08474C8.52599 3.17489 8.40126 3.3292 8.29253 3.62817C8.20643 3.86479 8.20121 3.9432 8.25844 4.13998C8.34029 4.42137 8.67261 4.78016 8.85139 4.78016C8.96965 4.78016 8.98116 4.80716 8.98405 5.0921C8.98609 5.29344 9.025 5.4644 9.09375 5.57412C9.20293 5.74847 9.5699 6.12322 9.6319 6.12368C9.7092 6.12433 10.4197 5.38611 10.4194 5.30542C10.4193 5.25757 10.3488 5.13949 10.2628 5.04308C9.94311 4.68493 9.82208 4.37515 9.96597 4.28354C10.0545 4.22721 10.0326 3.69512 9.93296 3.48216C9.79287 3.1826 9.59259 3.06271 9.20162 3.04448C9.01371 3.03572 8.80221 3.05383 8.73165 3.08474ZM5.3445 4.56323C4.85825 4.84689 4.72638 5.47445 5.0587 5.92322C5.3411 6.30463 5.73666 6.39186 6.16795 6.1678C6.44037 6.02629 6.67627 5.65347 6.67627 5.36443C6.67627 5.09765 6.43946 4.70362 6.19415 4.56229C5.90562 4.39601 5.63065 4.3963 5.3445 4.56323ZM17.9917 4.57503C17.8981 4.61762 17.7597 4.72069 17.6841 4.80394C17.55 4.95159 17.5283 4.95544 16.8262 4.95544C16.43 4.95544 16.0249 4.9721 15.9261 4.99249C15.6605 5.04717 14.8653 5.88986 14.6316 6.36429C14.4075 6.81914 14.3171 7.21048 14.3994 7.36887C14.4648 7.49472 14.6193 7.68327 15.0486 8.16073L15.3384 8.48313L15.3796 7.77225C15.4258 6.97502 15.4673 6.87581 15.9944 6.30048L16.2632 6.00712H16.9686C17.6586 6.00712 17.6796 6.01098 17.9262 6.1824C18.0737 6.28494 18.2523 6.35768 18.3567 6.35768C18.6164 6.35768 18.9592 6.15582 19.1242 5.90575C19.6118 5.16654 18.7966 4.20858 17.9917 4.57503ZM16.7222 6.94306C16.5148 7.03403 16.2649 7.35988 16.2525 7.55543C16.2207 8.05737 16.3354 8.39695 16.5744 8.50919C16.6778 8.55768 16.7042 8.63293 16.7348 8.96696C16.755 9.18676 16.7716 9.59429 16.7719 9.87246L16.7723 10.3783L17.0696 10.632C17.2332 10.7716 17.431 10.9532 17.5092 11.0356C17.7157 11.2532 18.3949 11.7914 18.4629 11.7914C18.4949 11.7914 18.5296 11.8131 18.54 11.8396C18.5583 11.8864 19.5588 12.6109 19.839 12.7803C20.2668 13.0391 20.4521 13.0815 20.5593 12.9453C20.6619 12.8149 20.8066 12.2968 20.7758 12.1702C20.7512 12.069 20.0636 11.5419 19.5576 11.2363C19.444 11.1677 18.9688 10.789 18.9276 10.7342C18.912 10.7135 18.7078 10.5386 18.4738 10.3457C17.744 9.74386 17.7932 9.83389 17.7932 9.09941C17.7932 8.64824 17.8169 8.41839 17.8728 8.32754C17.9858 8.14402 18.0322 7.7636 17.9689 7.54141C17.9392 7.43735 17.8285 7.2578 17.7229 7.14253C17.5527 6.95667 17.4926 6.93009 17.1941 6.9083C17.0089 6.8948 16.7965 6.91046 16.7222 6.94306ZM19.2395 7.81765C19.0016 7.97896 18.8708 8.25895 18.8713 8.60618C18.8719 9.13406 19.1925 9.45354 19.7217 9.45354C20.2578 9.45354 20.5728 9.12337 20.572 8.56189C20.5716 8.21951 20.456 7.98913 20.1958 7.81239C19.9711 7.65984 19.4682 7.66258 19.2395 7.81765ZM11.4926 9.75811C11.4431 9.79989 11.3027 9.96553 11.1806 10.1262C11.0585 10.2869 10.9458 10.4315 10.9301 10.4475C10.9145 10.4636 10.7358 10.6739 10.5331 10.9148C9.89927 11.6681 9.73751 11.8445 8.71458 12.898C7.7689 13.8719 7.3932 14.228 6.89481 14.6229C6.77462 14.7182 6.67627 14.8168 6.67627 14.842C6.67627 14.8673 6.64014 14.888 6.5959 14.888C6.55171 14.888 6.50707 14.9119 6.49664 14.9411C6.47032 15.0152 5.63604 15.6247 5.26884 15.8382C5.10175 15.9354 4.9448 16.0702 4.92013 16.138C4.86942 16.277 5.05042 16.6949 5.26067 16.9241C5.41824 17.0958 5.61664 17.0659 5.97562 16.8164C6.11452 16.7198 6.24203 16.6408 6.25893 16.6408C6.27589 16.6408 6.3482 16.5947 6.41973 16.5385C6.49119 16.4823 6.60616 16.3968 6.67519 16.3486C7.23954 15.9544 8.54675 14.8073 9.27712 14.0653C9.75316 13.5817 10.9316 12.2782 11.115 12.0323C11.2139 11.8998 11.3149 11.7914 11.3394 11.7914C11.3639 11.7914 11.3839 11.7547 11.3839 11.71C11.3839 11.6428 11.4963 11.5577 11.5849 11.5577C11.6206 11.5577 11.8315 11.8026 12.0721 12.1233C12.2926 12.4172 12.2962 12.4293 12.1961 12.5372C12.1393 12.5984 11.9908 12.7758 11.8661 12.9314C11.4387 13.4645 11.1313 13.8077 10.4781 14.4813C9.45834 15.5326 9.06312 15.8812 7.833 16.8141C7.36835 17.1665 6.95703 17.4824 6.91891 17.516C6.8808 17.5496 6.73741 17.6386 6.60032 17.7137C6.04453 18.0181 5.96529 18.1283 6.08588 18.4293C6.22444 18.775 6.43759 19.0363 6.58109 19.0363C6.70843 19.0363 7.59614 18.5348 7.63102 18.4432C7.64146 18.4159 7.67361 18.3936 7.70254 18.3936C7.81207 18.3936 9.48114 17.0987 10.0943 16.538C10.5483 16.1229 12.121 14.4894 12.4066 14.1364C12.5461 13.9641 12.6856 13.7931 12.7168 13.7565C13.599 12.7224 13.8407 12.3942 13.7866 12.3039C13.7298 12.2094 13.502 11.9411 13.2819 11.7096C13.187 11.61 12.9573 11.3457 12.7714 11.1223C12.5854 10.8989 12.395 10.6732 12.3482 10.6207C12.3014 10.5682 12.161 10.3978 12.0362 10.2421C11.561 9.64897 11.5906 9.67527 11.4926 9.75811ZM4.20303 10.0337C4.10616 10.0585 3.96016 10.1289 3.87866 10.1901C3.71644 10.312 3.5 10.727 3.5 10.9162C3.5 11.123 3.66687 11.4638 3.84973 11.6307C4.00372 11.7711 4.07258 11.7914 4.39752 11.7914C4.86404 11.7914 5.09233 11.6489 5.25721 11.2547C5.32017 11.1041 5.37173 10.9512 5.37173 10.915C5.37173 10.8787 5.32017 10.7258 5.25721 10.5752C5.07594 10.1419 4.64487 9.92048 4.20303 10.0337ZM14.3553 13.588C14.2351 13.7407 14.1169 13.8744 14.0926 13.8852C14.0683 13.8961 14.0214 13.9569 13.9884 14.0206C13.9354 14.1225 14.0281 14.2375 14.7744 14.9941C15.7673 16.0009 16.0663 16.2882 16.4887 16.6413C16.6602 16.7847 16.8134 16.9187 16.829 16.939C16.8719 16.9949 17.8494 17.7095 18.0835 17.856C18.1964 17.9267 18.3259 17.9846 18.3714 17.9846C18.4798 17.9846 18.6532 17.7762 18.774 17.5006C18.9456 17.1089 18.9436 17.105 18.3283 16.6393C18.1432 16.4991 17.9662 16.3554 17.935 16.3198C17.9038 16.2841 17.7507 16.1529 17.5947 16.0279C17.4387 15.903 17.2696 15.7598 17.2189 15.7096C17.1682 15.6594 16.9899 15.5 16.8227 15.3554C16.4663 15.0472 15.6634 14.2647 15.1292 13.7048C14.9222 13.488 14.7126 13.3105 14.6633 13.3105C14.6142 13.3105 14.4755 13.4353 14.3553 13.588ZM16.6408 18.4374C16.6273 18.4615 16.5732 18.6653 16.5206 18.8902C16.3017 19.8271 15.9971 20.4439 15.5185 20.9195C15.0908 21.3446 14.8431 21.4544 14.305 21.4575C13.8173 21.4603 13.6266 21.3907 13.3032 21.0916C12.9367 20.7527 12.7256 20.6806 12.1409 20.6949C11.8449 20.7022 11.5854 20.7329 11.5642 20.7632C11.5251 20.8193 11.3601 20.9435 10.8843 21.2755C10.6399 21.4459 10.581 21.461 10.1609 21.461C9.78759 21.461 9.65407 21.4348 9.43435 21.3185C9.0022 21.0899 8.56654 20.6046 8.31545 20.0723C8.24375 19.9202 8.16917 19.7958 8.14971 19.7958C8.11234 19.7958 7.44481 20.113 7.30018 20.1995C7.16036 20.2831 7.22474 20.571 7.48389 21.0208C7.61684 21.2516 7.75109 21.4857 7.78229 21.5411C8.15476 22.2032 9.18903 23.1461 9.92343 23.4931C10.0404 23.5483 10.2191 23.6323 10.3205 23.6798C10.4941 23.7611 10.7111 23.8236 11.2422 23.9454C11.3669 23.974 11.8152 23.9986 12.2383 24C12.9756 24.0024 13.6167 23.8994 14.0214 23.7135C14.5829 23.4555 14.965 23.2522 15.1534 23.1111C15.5936 22.7812 16.4879 21.8617 16.4884 21.7385C16.4885 21.6984 16.5101 21.6655 16.5362 21.6655C16.5625 21.6655 16.6138 21.6063 16.6503 21.534C16.6868 21.4617 16.766 21.3237 16.8263 21.2273C16.8865 21.1309 17.0021 20.9074 17.0831 20.7306C17.1641 20.5539 17.255 20.3636 17.2849 20.3078C17.3544 20.1786 17.6736 19.2593 17.6791 19.1727C17.6795 19.1674 17.5481 19.0635 17.387 18.9417C17.2261 18.82 17.0162 18.6469 16.9207 18.557C16.7406 18.3876 16.6828 18.3628 16.6408 18.4374Z" fill="#808080"/>
</g>
<defs>
<clipPath id="clip0_375_877">
<rect width="24" height="24" fill="white"/>
</clipPath>
</defs>
</svg>
`;

const UserSvg = `
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 256 256"><path d="M230.92 212c-15.23-26.33-38.7-45.21-66.09-54.16a72 72 0 1 0-73.66 0c-27.39 8.94-50.86 27.82-66.09 54.16a8 8 0 1 0 13.85 8c18.84-32.56 52.14-52 89.07-52s70.23 19.44 89.07 52a8 8 0 1 0 13.85-8M72 96a56 56 0 1 1 56 56 56.06 56.06 0 0 1-56-56" fill="#fff"/></svg>
`;

const loaderSvg = `
  <svg id="dots" width="25px" height="22px" viewBox="0 0 132 58" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
    <defs></defs>
    <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" sketch:type="MSPage">
        <g id="dots" sketch:type="MSArtboardGroup" fill="#A3A3A3">
            <circle id="dot1" sketch:type="MSShapeGroup" cx="25" cy="30" r="13"></circle>
            <circle id="dot2" sketch:type="MSShapeGroup" cx="65" cy="30" r="13"></circle>
            <circle id="dot3" sketch:type="MSShapeGroup" cx="105" cy="30" r="13"></circle>
        </g>
    </g>
  </svg>
`;

let stepsArray = [];
let totalStepsCompleted = 0;
let coderTabInterval;
let plannerTabInterval;
let researcherTabInterval;

const userInput = document.getElementById('userInput');
userInput.addEventListener('keydown', onInputChange);
userInput.addEventListener('paste', () => setTimeout(adjustTextAreaHeight, 0));
document.getElementById('sendBtn').addEventListener('click', sendUserMessage);

// Settings modal
document.getElementById('saveSettings').onclick = function () {
  saveSettings();
};
document.getElementById('openSettings').onclick = function () {
  openSettings();
};
document.getElementById('closeSettings').onclick = function () {
  closeSettings();
};

// // Planner modal
// document.getElementById('progressCircle').addEventListener('click', () => {
//   document.getElementById('plannerModal').style.display = 'flex';
// });

// document.getElementById('closePlanner').addEventListener('click', () => {
//   document.getElementById('plannerModal').style.display = 'none';
// });

// IMP: Acquire the VS Code API
const vscode = acquireVsCodeApi();

// Listen for messages from the extension
window.addEventListener('message', (event) => {
  console.log(`Received message in chat.js: ${event.data.type}`, event.data);
  switch (event.data.type) {
    case 'settingSaved':
      settingSaved(event.data.content.message);
      disableSendButton(!event.data.content.allowUserMessage);
      break;

    case 'botMessage':
      sendBotMessage(event.data.content.message, event.data.content.allowUserMessage);
      disableSendButton(!event.data.content.allowUserMessage, event.data.content.messageInputText);
      break;

    case 'plannedSteps':
      totalStepsCompleted = 0;
      displayPlannedSteps(event.data.content);
      break;

    case 'plannedStepStart':
      updateStepStatus(event.data.content, 'started');
      break;

    case 'plannedStepComplete':
      updateStepStatus(event.data.content, 'completed');
      break;

    case 'solutionCompleted':
      sendBotMessage(event.data.content.message, event.data.content.allowUserMessage);
      disableSendButton(!event.data.content.allowUserMessage);
      removRecentUserLoader();
      markSolutionCompleted(event.data.content);
      break;

    case 'tokenUsed':
      displayTokenUsed(event.data.content.message);
      break;

    case 'tokenUsesByAgent':
      displayTokenUsesByAgent(event.data.content.message);
      break;

    case 'availableHeaderLogs':
      createTabs(event.data.content);
      break;

    case 'displayLogs':
      displayLogs(event.data.content);
      break;

    default:
      sendBotMessage(`Unknown message received from facilitator: ${event.data}`, false);
  }
});

function updateIconColors() {
  const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;

  const iconColor = isDarkMode ? '#FFFFFF' : '#000000';

  document.querySelectorAll('.icon').forEach((iconElement) => {
    iconElement.style.color = iconColor;
  });
}

function sendUserMessage() {
  const message = userInput.value.trim();
  if (message) {
    displayMessage(message, 'user');
    vscode.postMessage({ type: 'userMessage', content: message });
    userInput.value = '';
    adjustTextAreaHeight();
  }
  disableSendButton(true);
}

function sendBotMessage(message, allowUserInput) {
  message = message.trim();
  if (message) {
    displayMessage(message, 'bot', allowUserInput);
    adjustTextAreaHeight();
  }
}

function onInputChange(event) {
  removRecentUserLoader();
  adjustTextAreaHeight();

  // Check if "Command" key (Mac) or "Ctrl" key (Windows/Linux) and "Enter" key are pressed
  if ((event.metaKey || event.ctrlKey) && event.key === 'Enter') {
    sendUserMessage();
  }
}

function adjustTextAreaHeight() {
  const minHeight = 15;
  const maxHeight = 90;

  userInput.style.height = minHeight + 'px';
  const newHeight = Math.min(maxHeight, Math.max(userInput.scrollHeight, minHeight));
  userInput.style.height = newHeight + 'px';

  updateMessageContainerHeight();
}

function updateMessageContainerHeight() {
  const chatContainer = document.getElementById('chatContainer');

  const inputontainerHeight = document.getElementById('inputContainer').offsetHeight;
  const headerHeight = document.getElementById('jHeader').offsetHeight;

  const totalHeight = inputontainerHeight + headerHeight;

  chatContainer.style.height = `calc(100vh - ${totalHeight}px)`;
}

function displayMessage(msg, sender, allowUserInput) {
  const chatListContainerElement = document.getElementById('messageContainer');

  const messageElement = createMessageElement(msg, sender, allowUserInput);

  userInput.value = '';

  // Defer the scrolling a bit to ensure layout updates
  chatListContainerElement.appendChild(messageElement);

  if (sender === 'bot' && allowUserInput) {
    displayMessage('Waiting for your input', 'user', true);
  }

  chatListContainerElement.scrollTop = chatListContainerElement.scrollHeight + 10;
}

function removRecentUserLoader() {
  const userMessages = document.querySelectorAll('.user-input-waiting');

  if (userMessages.length <= 0) {
    return;
  }

  const recentMessage = userMessages[userMessages.length - 1];

  recentMessage.remove();
}

function createMessageElement(msg, sender, allowUserInput) {
  removeAllLoaderInstanceFromDOM('message-loader');

  const chatElement = document.createElement('div');

  // Construct user message HTML format
  if (sender === 'user') {
    if (allowUserInput) {
      const loaderElement = document.createElement('div');
      loaderElement.classList.add('message-loader');
      loaderElement.innerHTML = loaderSvg;
      chatElement.appendChild(loaderElement);
    }

    const messageElement = document.createElement('div');
    if (allowUserInput) {
      messageElement.classList.add('user-text-inactive');
      chatElement.classList.add('user-message', 'user-input-waiting');
    } else {
      messageElement.classList.add('user');
      chatElement.classList.add('user-message');
    }
    messageElement.textContent = msg;

    chatElement.appendChild(messageElement);
    // Replace new line characters with HTML line break to properly display in HTML
    const formattedMessage = messageElement.innerHTML.replace(/\n/g, '<br>');
    messageElement.innerHTML = formattedMessage;

    const iconElement = document.createElement('div');
    iconElement.classList.add('icon');
    iconElement.innerHTML = UserSvg;
    chatElement.appendChild(iconElement);
  }

  // Construct bot message HTML format
  if (sender === 'bot') {
    chatElement.classList.add('bot-message');
    const iconElement = document.createElement('div');
    iconElement.classList.add('boticon');
    iconElement.innerHTML = BotSvg;
    chatElement.appendChild(iconElement);

    const messageElement = document.createElement('div');
    messageElement.classList.add('bot');
    messageElement.textContent = msg;
    chatElement.appendChild(messageElement);
    const formattedMessage = messageElement.innerHTML.replace(/\n/g, '<br>');
    messageElement.innerHTML = formattedMessage;

    if (!allowUserInput) {
      const loaderElement = document.createElement('div');
      loaderElement.classList.add('message-loader');
      loaderElement.innerHTML = loaderSvg;
      chatElement.appendChild(loaderElement);
    }
  }

  return chatElement;
}

function removeAllLoaderInstanceFromDOM(className) {
  var elementsToRemove = document.querySelectorAll(`.${className}`);

  // Iterate over the NodeList and remove each element
  elementsToRemove.forEach(function (element) {
    element.remove();
  });
}

function openSettings() {
  document.getElementById('settingsModal').style.display = 'flex';
  //  vscode.postMessage({ type: 'requestEnvVariables' });
}

function closeSettings() {
  document.getElementById('settingsModal').style.display = 'none';
}

function saveSettings() {
  const openAIKey = document.getElementById('SIRJI_OPENAI_API_KEY').value.trim();

  let isValid = true;

  document.getElementById('save_settings_error').textContent = '';

  if (!openAIKey) {
    document.getElementById('SIRJI_OPENAI_API_KEY_ERROR').textContent = 'OpenAI API Key is required.';
    isValid = false;
  } else {
    document.getElementById('SIRJI_OPENAI_API_KEY_ERROR').textContent = '';
  }

  if (isValid) {
    const saveButton = document.getElementById('saveSettings');
    saveButton.textContent = 'Saving...';
    saveButton.disabled = true;

    const settings = {
      SIRJI_OPENAI_API_KEY: openAIKey,
    };

    vscode.postMessage({ type: 'saveSettings', content: settings });
  }
}

function settingSaved(data) {
  const saveButton = document.getElementById('saveSettings');
  saveButton.textContent = 'Save';
  saveButton.disabled = false;
  if (data.success) {
    sendBotMessage(data.message, false);
    closeSettings();
  } else {
    document.getElementById('save_settings_error').textContent = `Settings can not be saved. Please contact Sirji team. Error: ${data.message}`;
  }
}

function updateStepStatus(message, status) {
  let stepNumber = message.match(/\d+/g);

  if (!stepNumber) {
    return;
  }

  if (stepNumber && stepNumber.length === 0) {
    return;
  }

  if (stepsArray?.length === 0 || !stepsArray) {
    return;
  }

  if (stepNumber.length === 1) {
    console.log('Updating step:', stepNumber[0], stepsArray[0]);
    stepsArray[stepNumber[0] - 1].status = status;
    if (status === 'completed') {
      for (let i = 0; i < stepNumber[0] - 1; i++) {
        stepsArray[i].status = status;
      }
    }
  }

  let maxStepNumber = 0;
  if (stepNumber.length === 2) {
    maxStepNumber = Math.max(...stepNumber);
    for (let i = 0; i < maxStepNumber - 1; i++) {
      stepsArray[i].status = status;
    }
  }

  if (status === 'completed') {
    totalStepsCompleted = stepsArray.length;
    setProgress(totalStepsCompleted, stepsArray.length);

    toggleProgressTextColor();
  }

  totalStepsCompleted = stepsArray.filter((step) => step.status === 'completed').length;

  displayPlannedSteps(stepsArray);
}

function displayPlannedSteps(steps) {
  setProgress(totalStepsCompleted, steps.length);
  // document.getElementById('progressCircle').style.visibility = 'visible';
  stepsArray = steps;
  const listElement = document.getElementById('stepsList');
  listElement.innerHTML = '';

  if (!steps) {
    return;
  }

  if (steps.length === 0) {
    return;
  }

  steps.forEach((step, index) => {
    step.status = step.status || '';
    const listItem = document.createElement('li');
    listItem.className = 'stepItem';
    const stepDescription = step.description;

    if (step.status === 'started') {
      listItem.innerHTML = `<div class="loader-wrapper"><div class="loader"></div></div><label>${stepDescription}</label>`;
    } else {
      listItem.innerHTML = `
      <input type="checkbox" class="checkbox" id="checkbox-${index}" ${step.status === 'completed' ? 'checked' : ''}>
      <label for="checkbox-${index}">${stepDescription}</label>
      `;
    }
    listElement.appendChild(listItem);
  });
}

function setProgress(x, y) {
  const progressText = document.getElementById('progressText');
  progressText.textContent = `STEPS (${x}/${y})`;
}

function disableSendButton(disable, message) {
  const sendButton = document.getElementById('sendBtn');
  if (sendButton) {
    sendButton.disabled = disable;
    updatePlaceholder(disable, message);
  }
}

function updatePlaceholder(disable, message) {
  const placeholderText = disable ? message || 'Sirji> is working on the problem. We will open the chat window when we have some information, questions, or feedback..' : 'Type a message...';
  userInput.placeholder = placeholderText;
  userInput.disabled = disable;

  adjustTextAreaHeight();
}

function markSolutionCompleted() {
  if (stepsArray?.length === 0) {
    return;
  }

  stepsArray.forEach((step) => {
    step.status = 'completed';
  });
  totalStepsCompleted = stepsArray.length;
  setProgress(stepsArray.length, stepsArray.length);
  displayPlannedSteps(stepsArray);
}

function toggleProgressTextColor() {
  // Select the element with id "progressText"
  const progressText = document.getElementById('progressText');

  // Update the background color
  progressText.style.backgroundColor = '#78a866';

  setTimeout(() => {
    progressText.style.backgroundColor = 'transparent';
  }, 2000);
}

function convertNumber(number) {
  if (number >= 1000000) {
    return (Math.ceil(number / 100000) / 10).toFixed(1).replace('.0', '') + 'M';
  } else if (number >= 100000) {
    return (Math.ceil(number / 10000) / 100).toFixed(1).replace('.0', '') + 'M';
  } else if (number >= 1000) {
    return (
      Math.ceil(number / 1000)
        .toFixed(1)
        .replace('.0', '') + 'K'
    );
  } else {
    return ''; // Don't show tokens less than 1K
  }
}

function displayTokenUsed(data = {}) {
  console.log('display token used', data);
  const { total_completion_tokens = 0, total_completion_tokens_value = 0, total_prompt_tokens = 0, total_prompt_tokens_value = 0 } = data;

  const totalTokensUsed = total_completion_tokens + total_prompt_tokens;

  if (totalTokensUsed < 1000) {
    return;
  }

  updateTokensUsed(totalTokensUsed);

  updateTooltipTokenValues(data);
}

function updateTokensUsed(totalTokensUsed) {
  const tokens = convertNumber(totalTokensUsed);

  const jTokensUsed = document.getElementById('jTokensUsed');
  jTokensUsed.textContent = `${tokens} tokens`;

  document.getElementById('jTokensContainer').style.display = 'flex';
}

function updateTooltipTokenValues(tokenValues) {
  console.log('updateTooltipTokenValues values:', tokenValues);
  const { total_completion_tokens = 0, total_completion_tokens_value = 0, total_prompt_tokens = 0, total_prompt_tokens_value = 0 } = tokenValues;

  const jPromptTokensUsed = document.getElementById('jPromptTokensUsed');
  jPromptTokensUsed.textContent = `Prompt Tokens - ${total_prompt_tokens} | $${total_prompt_tokens_value.toFixed(2)}`;

  const jCompletionTokensUsed = document.getElementById('jCompletionTokensUsed');
  jCompletionTokensUsed.textContent = `Completion Tokens - ${total_completion_tokens} | $${total_completion_tokens_value.toFixed(2)}`;
}

const tabButtons = document.querySelectorAll('.tab-button');

tabButtons.forEach(function (button) {
  button.addEventListener('click', function () {
    const tabName = this.getAttribute('data-tab');
    showTab(tabName);
  });
});

function showTab(tabName, tabClassName = 'tab', tabButtonClassName = 'tab-button') {
  let i, tabcontent, tablinks;

  // Get all elements with class="tab" and hide them
  tabcontent = document.getElementsByClassName(tabClassName);
  for (i = 0; i < tabcontent.length; i++) {
    tabcontent[i].style.display = 'none';
  }

  // Get all elements with class="tab-button" and remove the class "active"
  tablinks = document.getElementsByClassName(tabButtonClassName);
  for (i = 0; i < tablinks.length; i++) {
    tablinks[i].classList.remove('active');
  }

  // Show the current tab, and add an "active" class to the button that opened the tab
  document.getElementById(`${tabName}Tab`).style.display = 'block';
  document.querySelector('[data-tab="' + tabName + '"]').classList.add('active');

  // scroll to bottom
  scrollToBottom(`${tabName}Logs`);

  // adjust the tabs
  toggleTabsArrowOnResize();
}

function scrollToBottom(elementId) {
  const domElement = document.getElementById(elementId);

  if (!domElement) {
    return;
  }

  domElement.scrollTop = domElement.scrollHeight + 25;
}

updateIconColors();

vscode.postMessage({
  type: 'webViewReady',
  content: true,
});

function debounce(func, delay) {
  let timer;
  return function () {
    const context = this;
    const args = arguments;
    clearTimeout(timer);
    timer = setTimeout(() => {
      func.apply(context, args);
    }, delay);
  };
}

const jLeft = document.getElementById('jLeft');
const jRight = document.getElementById('jRight');
const jResizeHandle = document.getElementById('jResizeHandle');
const jWrap = document.getElementById('jWrap');
const winWidth = window.innerWidth;
const winHeight = window.innerHeight;

document.addEventListener('DOMContentLoaded', function (event) {
  jLeft.style.width = winWidth / 1 + 'px';
  jRight.style.width = winWidth / 3 + 'px';

  rStartWidth = parseInt(window.getComputedStyle(jRight).width, 10);
  jResizeHandle.style.right = rStartWidth - 4 + 'px';

  jResizeHandle.addEventListener('mousedown', setup, false);
});

let StartX, rStartWidth, lStartWidth;

function setup(event) {
  StartX = event.clientX;
  rStartWidth = parseInt(window.getComputedStyle(jRight).width, 10);
  lStartWidth = parseInt(window.getComputedStyle(jLeft).width, 10);

  document.documentElement.addEventListener('mousemove', drag, false);
  document.documentElement.addEventListener('mouseup', destroy, false);
}

function drag(event) {
  event.preventDefault();

  (jWrap.style.gridTemplateAreas = lStartWidth + event.clientX - StartX + 'px'), rStartWidth - event.clientX + StartX + 'px';
  jRight.style.width = rStartWidth - event.clientX + StartX + 'px';
  jLeft.style.width = lStartWidth + event.clientX - StartX + 'px';

  jResizeHandle.style.right = rStartWidth - event.clientX + StartX - 4 + 'px';

  toggleTabsArrowOnResize();
}

function destroy(e) {
  document.documentElement.removeEventListener('mousemove', drag, false);
  document.documentElement.removeEventListener('mouseup', destroy, false);

  toggleTabsArrowOnResize();
}

const jTabsButtonsContainerEl = document.getElementById('jTabsButtonsContainer');
const jTabButtonsEl = document.getElementById('jTabButtons');
const jRArrowSvg = document.getElementById('jRightArrowSvg');
const jLArrowSvg = document.getElementById('jLeftArrowSvg');

function toggleTabsArrowOnResize() {
  if (jTabsButtonsContainerEl.offsetWidth < jTabButtonsEl.offsetWidth) {
    jRArrowSvg.style.display = 'flex';
  } else {
    jRArrowSvg.style.display = 'none';
  }
}

window.addEventListener('resize', function () {
  setup();
});

jTabsButtonsContainerEl.addEventListener('scroll', function () {
  const totalScrolledWidth = jTabsButtonsContainerEl.offsetWidth + jTabsButtonsContainerEl.scrollLeft;

  if (jTabsButtonsContainerEl.scrollLeft === 0) {
    jLArrowSvg.style.display = 'none';
  } else {
    jLArrowSvg.style.display = 'flex';
  }

  console.log('totalScrolledWidth:', totalScrolledWidth, jTabButtonsEl.offsetWidth);

  if (totalScrolledWidth >= jTabButtonsEl.offsetWidth) {
    jRArrowSvg.style.display = 'none';
  } else {
    jRArrowSvg.style.display = 'flex';
  }
});

jRArrowSvg.onclick = function () {
  jTabsButtonsContainerEl.scrollLeft = 999999;
};

jLArrowSvg.onclick = function () {
  jTabsButtonsContainerEl.scrollLeft = 0;
};

// Tokens modal
const jTokensButton = document.getElementById('jTokensButton');
const jTokensModal = document.getElementById('jTokensModal');
const jCloseTokensModalButton = document.getElementById('jCloseTokensModalButton');
const jTabsBackdrop = document.getElementById('jTabsBackdrop');
const jBackdrop = document.getElementById('jBackdrop');
let isOpen = false;

function tokensButtonClickhandler(e) {
  if (isOpen) {
    closeTokensModal();
  } else {
    openTokensModal();
  }
}

function displayTokenUsesByAgent(data) {
  console.log('Token uses by agent:', data);
  const agents = Object.keys(data);

  let totalTokens = 0;

  let totalTokenValuationInDollar = 0;

  const tokensTable = document.getElementById('tokensTable');

  tokensTable.querySelectorAll('.tokens-table-row').forEach((row) => row.remove());

  agents.forEach((agent) => {
    const agentData = data[agent];
    const completionTokens = agentData.completion_tokens;
    const completionTokenValuationInDollar = agentData.completion_token_valuation_in_dollar;
    const promptTokens = agentData.prompt_tokens;
    const promptTokenValuationInDollar = agentData.prompt_token_valuation_in_dollar;
    totalTokens += completionTokens + promptTokens;
    totalTokenValuationInDollar += completionTokenValuationInDollar + promptTokenValuationInDollar;
    const row = document.createElement('div');
    row.className = 'tokens-table-row';
    row.innerHTML = `<div class='truncate-text'>${agent}</div><div class="flex-shrink">${convertNumber(completionTokens + promptTokens)} | $${(
      completionTokenValuationInDollar + promptTokenValuationInDollar
    ).toFixed(2)}</div>`;
    tokensTable.insertBefore(row, tokensTable.querySelector('.tokens-table-footer-row'));
  });

  document.getElementById('totalRow').innerHTML = `${convertNumber(totalTokens)} | $${totalTokenValuationInDollar.toFixed(2)}`;

  jTokensModal.style.display = 'flex';
  jTabsBackdrop.style.display = 'flex';
  jBackdrop.style.display = 'flex';
  document.body.addEventListener('click', modalClickHandler);
  isOpen = !isOpen;
}

function openTokensModal() {
  vscode.postMessage({ type: 'requestTokenUsage' });
}

function closeTokensModal() {
  jTokensModal.style.display = 'none';
  jTabsBackdrop.style.display = 'none';
  jBackdrop.style.display = 'none';
  document.body.removeEventListener('click', modalClickHandler);
  isOpen = !isOpen;
}

function modalClickHandler(event) {
  if (event.target.classList.contains('backdrop')) {
    closeTokensModal();
  }
}
const logTabButtonsContainer = document.getElementById('jTabButtons');
const logTabContentContainer = document.getElementById('logTabContent');
let currentActiveLog = null;
let fetchLogsInterval = null;

// Function to create tabs
function createTabs(logs) {
  // Preserve currently active tab
  const activeTab = document.querySelector('.log-tab-button.active');
  if (activeTab) currentActiveLog = activeTab.getAttribute('data-tab');

  // Fetch existing logs
  const existingLogsIds = Array.from(logTabContentContainer.children).map((child) => child.id.slice(0, -3));

  // Clear existing headers but not content
  logTabButtonsContainer.innerHTML = '';

  logs.forEach((log, index) => {
    // Create or update tab button
    const tabButton = document.createElement('div');
    tabButton.classList.add('log-tab-button');
    if (log === currentActiveLog) tabButton.classList.add('active'); // Restore active tab
    tabButton.setAttribute('data-tab', log);
    tabButton.innerText = log.replace(/_/g, ' ').toUpperCase();
    tabButton.addEventListener('click', () => {
      activateTab(log);
      // Call requestLogs on click
      requestLogs(log);
    });
    logTabButtonsContainer.appendChild(tabButton);

    if (!existingLogsIds.includes(log)) {
      // Create tab content if it doesn't exist
      const tabContent = document.createElement('div');
      tabContent.id = `${log}Tab`;
      tabContent.classList.add('log-tab');
      if (log === currentActiveLog) tabContent.classList.add('active'); // Restore active content
      const panelView = document.createElement('div');
      panelView.id = `${log}Logs`;
      panelView.classList.add('panel-view');
      tabContent.appendChild(panelView);
      logTabContentContainer.appendChild(tabContent);
    }
  });

  // If there's no previously active log, set the first one as active
  if (!currentActiveLog && logs.length > 0) {
    currentActiveLog = logs[0];
    activateTab(currentActiveLog);
  }
}

// Function to activate a tab
function activateTab(log) {
  // Keep track of the active tab
  currentActiveLog = log;

  // Clear existing interval to prevent memory leaks
  if (fetchLogsInterval) {
    clearInterval(fetchLogsInterval);
  }

  // Deactivate all tab buttons and contents
  document.querySelectorAll('.log-tab-button').forEach((btn) => btn.classList.remove('active'));
  document.querySelectorAll('.log-tab').forEach((tab) => tab.classList.remove('active'));

  // Activate the selected tab button and content
  document.querySelector(`[data-tab="${log}"]`).classList.add('active');
  document.getElementById(`${log}Tab`).classList.add('active');

  // Start fetching logs for the active tab every 10 seconds
  fetchLogsInterval = setInterval(() => {
    console.log('Requesting logs for:', log);
    requestLogs(log);
  }, 10000);
}

// Function to request logs
function requestLogs(log) {
  vscode.postMessage({ type: 'requestLogs', content: log });
}

// Function to display logs
function displayLogs(data) {
  const { fileName, logFileContent } = data;
  const logPanel = document.getElementById(`${fileName}Logs`);
  logPanel.innerHTML = `<pre>${logFileContent}</pre>`;
  scrollToBottom(`${fileName}Logs`);
}

// Loading initial headers
function loadHeaders() {
  vscode.postMessage({ type: 'requestAvailableHeaderLogs' });
}

// Initial load
loadHeaders();
setInterval(loadHeaders, 10000);

jCloseTokensModalButton.addEventListener('click', closeTokensModal);
jTokensButton.addEventListener('click', tokensButtonClickhandler);
